"""
Remove.bg Telegram Bot

üìå –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ—Ç —Ñ–æ–Ω —á–µ—Ä–µ–∑ API remove.bg.
- –ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –∫–∞—á–µ—Å—Ç–≤–æ, —Ä–∞–∑–º–µ—Ä, —Ñ–æ—Ä–º–∞—Ç, —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ü–≤–µ—Ç —Ñ–æ–Ω–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (–ø—Ä–µ–º–∏—É–º) –¥–ª—è HD/4K.
- –ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –∏ –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫.

üß∞ –ö–æ–º–∞–Ω–¥—ã:
  /start     ‚Äî –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
  /help      ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
  /settings  ‚Äî —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  /history   ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫

üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞:
- –£–∫–∞–∂–∏—Ç–µ API_ID, API_HASH –∏ BOT_TOKEN –æ—Ç Telegram.
- –£–∫–∞–∂–∏—Ç–µ REMOVEBG_API_KEY –æ—Ç remove.bg.
- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞):
  PREMIUM_USER_IDS=123,456
- –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_BOT_TOKEN, REMOVEBG_API_KEY
"""

import asyncio
import os
import tempfile
from collections import deque
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path
from typing import Deque, Dict, Optional

import requests
from telethon import Button, TelegramClient, events

API_ID = int(os.getenv("TELEGRAM_API_ID", "0"))
API_HASH = os.getenv("TELEGRAM_API_HASH", "")
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
REMOVEBG_API_KEY = os.getenv("REMOVEBG_API_KEY", "")
PREMIUM_USER_IDS = {
    int(user_id)
    for user_id in os.getenv("PREMIUM_USER_IDS", "").split(",")
    if user_id.strip().isdigit()
}

SESSION_NAME = "removebg_bot"

QUALITY_TO_SIZE = {
    "draft": "preview",
    "standard": "regular",
    "hd": "hd",
    "4k": "4k",
}

ALLOWED_FORMATS = {"png", "jpg"}
ALLOWED_TYPES = {"auto", "person", "product", "car"}

client = TelegramClient(SESSION_NAME, API_ID, API_HASH)


@dataclass
class UserSettings:
    quality: str = "standard"
    image_format: str = "png"
    image_type: str = "auto"
    bg_color: str = ""


user_settings: Dict[int, UserSettings] = {}
user_history: Dict[int, Deque[str]] = {}


def config_is_ready() -> bool:
    return all([API_ID, API_HASH, BOT_TOKEN, REMOVEBG_API_KEY])


def is_premium(user_id: int) -> bool:
    return user_id in PREMIUM_USER_IDS


def get_settings(user_id: int) -> UserSettings:
    if user_id not in user_settings:
        user_settings[user_id] = UserSettings()
    return user_settings[user_id]


def append_history(user_id: int, entry: str) -> None:
    history = user_history.setdefault(user_id, deque(maxlen=5))
    history.appendleft(entry)


def format_settings(user_id: int) -> str:
    settings = get_settings(user_id)
    premium_mark = "‚úÖ" if is_premium(user_id) else "‚ùå"
    return (
        "‚öôÔ∏è –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
        f"–ö–∞—á–µ—Å—Ç–≤–æ: {settings.quality}\n"
        f"–§–æ—Ä–º–∞—Ç: {settings.image_format}\n"
        f"–¢–∏–ø: {settings.image_type}\n"
        f"–¶–≤–µ—Ç —Ñ–æ–Ω–∞: {settings.bg_color or '–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π'}\n"
        f"–ü—Ä–µ–º–∏—É–º: {premium_mark}"
    )


def remove_background(input_path: Path, output_path: Path, settings: UserSettings) -> None:
    with input_path.open("rb") as image_file:
        response = requests.post(
            "https://api.remove.bg/v1.0/removebg",
            files={"image_file": image_file},
            data={
                "size": QUALITY_TO_SIZE.get(settings.quality, "regular"),
                "format": settings.image_format,
                "type": settings.image_type,
                "bg_color": settings.bg_color or "",
            },
            headers={"X-Api-Key": REMOVEBG_API_KEY},
            timeout=60,
        )
    if response.status_code != 200:
        raise RuntimeError(
            f"remove.bg error {response.status_code}: {response.text.strip()}"
        )
    output_path.write_bytes(response.content)


async def remove_background_async(
    input_path: Path, output_path: Path, settings: UserSettings
) -> None:
    loop = asyncio.get_running_loop()
    await loop.run_in_executor(None, remove_background, input_path, output_path, settings)


def main_menu_buttons() -> list:
    return [
        [Button.text("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"), Button.text("üßæ –ò—Å—Ç–æ—Ä–∏—è")],
        [Button.text("üéö –ö–∞—á–µ—Å—Ç–≤–æ"), Button.text("üñº –§–æ—Ä–º–∞—Ç")],
        [Button.text("üßç –¢–∏–ø"), Button.text("üé® –§–æ–Ω")],
        [Button.text("‚ÑπÔ∏è –ü–æ–º–æ—â—å")],
    ]


def quality_buttons(user_id: int) -> list:
    premium = is_premium(user_id)
    buttons = [
        Button.inline("Draft", data=b"quality:draft"),
        Button.inline("Standard", data=b"quality:standard"),
    ]
    if premium:
        buttons.extend(
            [Button.inline("HD", data=b"quality:hd"), Button.inline("4K", data=b"quality:4k")]
        )
    return [buttons]


def format_buttons() -> list:
    return [
        [Button.inline("PNG", data=b"format:png"), Button.inline("JPG", data=b"format:jpg")]
    ]


def type_buttons() -> list:
    return [
        [
            Button.inline("Auto", data=b"type:auto"),
            Button.inline("Person", data=b"type:person"),
            Button.inline("Product", data=b"type:product"),
            Button.inline("Car", data=b"type:car"),
        ]
    ]


def bg_buttons() -> list:
    return [
        [Button.inline("–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π", data=b"bg:clear")],
        [Button.inline("–ë–µ–ª—ã–π", data=b"bg:ffffff"), Button.inline("–ß—ë—Ä–Ω—ã–π", data=b"bg:000000")],
        [Button.inline("–ö—Ä–∞—Å–Ω—ã–π", data=b"bg:ff0000"), Button.inline("–°–∏–Ω–∏–π", data=b"bg:0000ff")],
    ]


@client.on(events.NewMessage(pattern="/start"))
async def start_handler(event):
    await event.respond(
        "–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏ —è —É–¥–∞–ª—é —Ñ–æ–Ω —á–µ—Ä–µ–∑ remove.bg.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ /help.",
        buttons=main_menu_buttons(),
    )


@client.on(events.NewMessage(pattern="/help"))
async def help_handler(event):
    await event.respond(
        "üß∞ –ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n"
        "/help ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞\n"
        "/settings ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n"
        "/history ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫\n\n"
        "–û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º ‚Äî —è –≤–µ—Ä–Ω—É PNG/JPG –±–µ–∑ —Ñ–æ–Ω–∞.",
        buttons=main_menu_buttons(),
    )


@client.on(events.NewMessage(pattern="/settings"))
async def settings_handler(event):
    await event.respond(format_settings(event.sender_id), buttons=main_menu_buttons())


@client.on(events.NewMessage(pattern="/history"))
async def history_handler(event):
    history = user_history.get(event.sender_id)
    if not history:
        await event.respond("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.", buttons=main_menu_buttons())
        return
    await event.respond("üßæ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:\n" + "\n".join(history))


@client.on(events.NewMessage)
async def menu_handler(event):
    if not event.text:
        return

    text = event.text.strip().lower()
    if text in {"‚öôÔ∏è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏"}:
        await event.respond(format_settings(event.sender_id), buttons=main_menu_buttons())
        return
    if text in {"üßæ –∏—Å—Ç–æ—Ä–∏—è", "–∏—Å—Ç–æ—Ä–∏—è"}:
        await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ /history –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏.")
        return
    if text in {"üéö –∫–∞—á–µ—Å—Ç–≤–æ", "–∫–∞—á–µ—Å—Ç–≤–æ"}:
        await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ:", buttons=quality_buttons(event.sender_id))
        return
    if text in {"üñº —Ñ–æ—Ä–º–∞—Ç", "—Ñ–æ—Ä–º–∞—Ç"}:
        await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç:", buttons=format_buttons())
        return
    if text in {"üßç —Ç–∏–ø", "—Ç–∏–ø"}:
        await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", buttons=type_buttons())
        return
    if text in {"üé® —Ñ–æ–Ω", "—Ñ–æ–Ω"}:
        await event.respond("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ–Ω:", buttons=bg_buttons())
        return
    if text in {"‚ÑπÔ∏è –ø–æ–º–æ—â—å", "–ø–æ–º–æ—â—å"}:
        await help_handler(event)


@client.on(events.CallbackQuery)
async def callback_handler(event):
    data = event.data.decode("utf-8")
    settings = get_settings(event.sender_id)

    if data.startswith("quality:"):
        quality = data.split(":", 1)[1]
        if quality in {"hd", "4k"} and not is_premium(event.sender_id):
            await event.answer("HD/4K –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ.", alert=True)
            return
        settings.quality = quality
        await event.answer(f"–ö–∞—á–µ—Å—Ç–≤–æ: {quality}")
        await event.edit(format_settings(event.sender_id), buttons=main_menu_buttons())
        return

    if data.startswith("format:"):
        image_format = data.split(":", 1)[1]
        if image_format in ALLOWED_FORMATS:
            settings.image_format = image_format
            await event.answer(f"–§–æ—Ä–º–∞—Ç: {image_format}")
            await event.edit(format_settings(event.sender_id), buttons=main_menu_buttons())
        return

    if data.startswith("type:"):
        image_type = data.split(":", 1)[1]
        if image_type in ALLOWED_TYPES:
            settings.image_type = image_type
            await event.answer(f"–¢–∏–ø: {image_type}")
            await event.edit(format_settings(event.sender_id), buttons=main_menu_buttons())
        return

    if data.startswith("bg:"):
        color = data.split(":", 1)[1]
        settings.bg_color = "" if color == "clear" else color
        await event.answer("–§–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω")
        await event.edit(format_settings(event.sender_id), buttons=main_menu_buttons())


@client.on(events.NewMessage)
async def image_handler(event):
    if event.text and event.text.startswith("/"):
        return

    if not config_is_ready():
        await event.respond(
            "‚ö†Ô∏è –ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TELEGRAM_API_ID, TELEGRAM_API_HASH, "
            "TELEGRAM_BOT_TOKEN –∏ REMOVEBG_API_KEY."
        )
        return

    if not (event.photo or (event.document and event.document.mime_type)):
        return

    mime_type: Optional[str] = None
    if event.document:
        mime_type = event.document.mime_type

    if mime_type and not mime_type.startswith("image/"):
        await event.respond("‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG/PNG).")
        return

    await event.respond("‚è≥ –£–¥–∞–ª—è—é —Ñ–æ–Ω, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    with tempfile.TemporaryDirectory() as temp_dir:
        input_path = Path(temp_dir) / "input"
        output_path = Path(temp_dir) / "output.png"
        await event.download_media(file=str(input_path))

        settings = get_settings(event.sender_id)
        if settings.quality in {"hd", "4k"} and not is_premium(event.sender_id):
            settings.quality = "standard"

        try:
            await remove_background_async(input_path, output_path, settings)
        except Exception as exc:
            await event.respond(f"‚ùå –û—à–∏–±–∫–∞ remove.bg: {exc}")
            return

        timestamp = datetime.now().strftime("%d.%m %H:%M")
        append_history(
            event.sender_id,
            f"{timestamp} ‚Äî {settings.quality}, {settings.image_format}, {settings.image_type}",
        )
        await event.respond(file=str(output_path), message="‚úÖ –ì–æ—Ç–æ–≤–æ!")


async def main() -> None:
    if not config_is_ready():
        print(
            "‚ö†Ô∏è –ù–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: "
            "TELEGRAM_API_ID, TELEGRAM_API_HASH, TELEGRAM_BOT_TOKEN, REMOVEBG_API_KEY"
        )
    await client.start(bot_token=BOT_TOKEN)
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è...")
    await client.run_until_disconnected()


if __name__ == "__main__":
    asyncio.run(main())
